<!doctype html>
<html class="no-js" lang="zh_CN">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="索引" href="../genindex.html" /><link rel="search" title="搜索" href="../search.html" /><link rel="next" title="学习 Rust" href="rust.html" /><link rel="prev" title="破解 WIFI" href="wifi.html" />

    <meta name="generator" content="sphinx-4.3.2, furo 2022.06.21"/>
        <title>启动 S7 核 - Notes</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=40978830699223671f4072448e654b5958f38b89" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  --color-brand-primary: #7C4DFF;
  --color-brand-content: #7C4DFF;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Notes</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">Notes</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=搜索 name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../papers/index.html">论文阅读</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../papers/theseus.html">Theseus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../papers/unikraft.html">Unikraft</a></li>
<li class="toctree-l2"><a class="reference internal" href="../papers/redleaf.html">Redleaf</a></li>
<li class="toctree-l2"><a class="reference internal" href="../papers/IPC.html">SkyBridge and XPC</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">其他</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="loongson.html">龙芯杯比赛回顾</a></li>
<li class="toctree-l2"><a class="reference internal" href="wifi.html">破解 WIFI</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">启动 S7 核</a></li>
<li class="toctree-l2"><a class="reference internal" href="rust.html">学习 Rust</a></li>
<li class="toctree-l2"><a class="reference internal" href="linux.html">学习 Linux</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/tkf2019/Blog/edit/main/source/others/s7.md" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <div class="section" id="s7">
<h1>启动 S7 核<a class="headerlink" href="#s7" title="永久链接至标题">#</a></h1>
<div class="section" id="id1">
<h2>硬件背景<a class="headerlink" href="#id1" title="永久链接至标题">#</a></h2>
<p>以下是一些相关的特性，具体参见<a class="reference external" href="https://sifive.cdn.prismic.io/sifive/de1491e5-077c-461d-9605-e8a0ce57337d_fu740-c000-manual-v1p3.pdf">官方文档</a></p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Feature</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ISA</p></td>
<td><p>RV64IMAC</p></td>
</tr>
<tr class="row-odd"><td><p>Modes</p></td>
<td><p>Machine Mode, User Mode</p></td>
</tr>
<tr class="row-even"><td><p>L1 i-cache</p></td>
<td><p>16KiB 2-way i-cache</p></td>
</tr>
<tr class="row-odd"><td><p>DTIM</p></td>
<td><p>8 KiB DTIM</p></td>
</tr>
<tr class="row-even"><td><p>L2 Cache</p></td>
<td><p>2 MiB 16-way L2 cache with 4 banks</p></td>
</tr>
<tr class="row-odd"><td><p>ECC</p></td>
<td><p>Single error correction, double error detection on the DTIM and L2 cache</p></td>
</tr>
<tr class="row-even"><td><p>Fast IO</p></td>
<td><p>Present</p></td>
</tr>
<tr class="row-odd"><td><p>PMP</p></td>
<td><p>8 regions with a granularity of 64 bytes</p></td>
</tr>
</tbody>
</table>
</div>
<p>启动S7核，核心的问题在于S7核只有M态和U态，官方给出的boot链中，U-Boot是工作在S态的，所以需要在官方boot链的基础上，加入自己的启动代码。</p>
</div>
<div class="section" id="id2">
<h2>启动准备<a class="headerlink" href="#id2" title="永久链接至标题">#</a></h2>
<ul class="simple">
<li><p>在整个boot链中，我们不能修改的部分是ZSBL，也就是板子出厂时烧写在ROM中的代码，这段代码主要工作是根据板子上的MSEL控制开关，由<strong>Hart 0</strong>将更复杂的U-Boot SPL程序从分区加载到L2 LIM中执行，对应地址为<code class="docutils literal notranslate"><span class="pre">0x08000000</span></code>。</p></li>
<li><p>如果想移除U-Boot SPL，并添加自己的FSBL（First Stage Bootloader），需要对启动位置（SD卡，Flash等）的第一个分区（GUID 5B193300-FC78-40CD-8002-E86C45580B47）进行覆写。对于SD卡，具体操作方法为直接执行如下命令：</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 将SD卡制作成如下分区格式</span>
sudo sgdisk -g --clear -a <span class="m">1</span> <span class="se">\</span>
	  --new<span class="o">=</span><span class="m">1</span>:34:2081         --change-name<span class="o">=</span><span class="m">1</span>:spl --typecode<span class="o">=</span><span class="m">1</span>:5B193300-FC78-40CD-8002-E86C45580B47 <span class="se">\</span>
	  --new<span class="o">=</span><span class="m">2</span>:2082:10273      --change-name<span class="o">=</span><span class="m">2</span>:uboot  --typecode<span class="o">=</span><span class="m">2</span>:2E54B353-1271-4842-806F-E436D6AF6985 <span class="se">\</span>
	  --new<span class="o">=</span><span class="m">3</span>:16384:282623    --change-name<span class="o">=</span><span class="m">3</span>:boot --typecode<span class="o">=</span><span class="m">3</span>:0x0700 <span class="se">\</span>
	  --new<span class="o">=</span><span class="m">4</span>:286720:13918207 --change-name<span class="o">=</span><span class="m">4</span>:root --typecode<span class="o">=</span><span class="m">4</span>:0x8300 <span class="se">\</span>
	  /dev/sdX
<span class="c1"># 覆写FSBL的二进制文件</span>
dd <span class="k">if</span><span class="o">=</span>&lt;your fsbl&gt;.bin <span class="nv">of</span><span class="o">=</span>/dev/sdX <span class="nv">seek</span><span class="o">=</span><span class="m">34</span>
</pre></div>
</div>
<ul class="simple">
<li><p>不建议替换或修改U-Boot SPL，因为这一部分进行了一系列的硬件初始化工作，为之后的程序执行提供了硬件环境，且后续阶段代码的修改更加灵活，相比之下，修改U-Boot SPL的意义也不是很大。如果对FSBL的具体操作感兴趣，可阅读U-Boot开源代码，但由于U-Boot已经相当完善，项目过于庞大，不适合上手，建议阅读上一代<a class="reference external" href="https://github.com/sifive/freedom-u540-c000-bootloader"><code class="docutils literal notranslate"><span class="pre">Hifive</span> <span class="pre">Unleashed</span></code>启动流程</a>，采用的是裸机程序。</p></li>
</ul>
</div>
<div class="section" id="id3">
<h2>启动流程<a class="headerlink" href="#id3" title="永久链接至标题">#</a></h2>
<div class="section" id="sd">
<h3>SD卡默认分区简介<a class="headerlink" href="#sd" title="永久链接至标题">#</a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/spl</span></code>：U-Boot SPL</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/uboot</span></code>：U-Boot Proper、OpenSBI generic FW_DYNAMIC、DTB with U-Boot overlay</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/boot</span></code>：FAT16分区，包含设置信息(EXTLINUX configuration)，内核镜像以及设备树信息(device tree blob)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/root</span></code>：EXT4分区，包含由<strong>FUSDK</strong>构建的文件系统</p></li>
</ul>
</div>
<div class="section" id="id4">
<h3>制作镜像<a class="headerlink" href="#id4" title="永久链接至标题">#</a></h3>
<ul class="simple">
<li><p>首先准备好制作镜像时的分区配置信息：</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>/dts-v1/;

/ {
    description = &quot;tCore Image&quot;;
    #address-cells = &lt;1&gt;;

    images {
        sbi {
            data = /incbin/(&quot;../sbi/sbi.bin&quot;);
            description = &quot;SBI for tCore&quot;;
            type = &quot;firmware&quot;;
            os = &quot;sbi&quot;;
            arch = &quot;riscv&quot;;
            compression = &quot;none&quot;;
            load = &lt;0x80000000&gt;;
            entry = &lt;0x80000000&gt;;
        };
        kernel {
            data = &lt;0x0 0x0 0x0 0x0&gt;;
            description = &quot;tCore Image&quot;;
            type = &quot;standalone&quot;;
            os = &quot;tCore&quot;;
            arch = &quot;riscv&quot;;
            compression = &quot;none&quot;;
            load = &lt;0x80200000&gt;;
        };
        fdt-1 {
            description = &quot;hifive-unmatched-a00&quot;;
            type = &quot;flat_dt&quot;;
            compression = &quot;none&quot;;
            data = [...];
        };
    };

    configurations {
        default = &quot;unmatched-sdcard&quot;;

        unmatched-sdcard {
            description = &quot;hifive-unmatched-a00&quot;;
            firmware = &quot;sbi&quot;;
            loadables = &quot;kernel&quot;;
            fdt = &quot;fdt-1&quot;;
        };
    };
};
</pre></div>
</div>
<ul class="simple">
<li><p>如上面的分区配置所示，完整的文件<a class="reference external" href="https://github.com/tkf2019/tCore/tree/main/bin">参考</a>，完整文件中包含了U-Boot Proper可识别的fdt信息，且原始的配置信息中，Kernel位置的是U-Boot Proper文件，已经将默认的Kernel位置的data注释掉了，因此，如果想在S7核上运行内核，可以选择将内核的二进制放在Kernel的位置；如果在U7核上运行内核，可以采用官方默认的U-Boot的启动办法。但是如果想不同的核同时运行不同的内核，欢迎持续关注<a class="reference external" href="https://github.com/rustsbi/rustsbi-hifive-unmatched">RustSBI</a>的更新情况，后续会引入功能：SBI根据<code class="docutils literal notranslate"><span class="pre">misa</span></code>等信息判断当前硬件支持的特权级别，并选择不同的加载方式。</p></li>
<li><p>执行以下命令覆写SD卡对应分区：</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkimage -f sd-image.dts target.img
dd <span class="k">if</span><span class="o">=</span>target.img <span class="nv">of</span><span class="o">=</span>/dev/sdX <span class="nv">seek</span><span class="o">=</span><span class="m">2082</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h2><a class="reference external" href="https://github.com/tkf2019/tCore/tree/main/sbi">运行实例</a><a class="headerlink" href="#id5" title="永久链接至标题">#</a></h2>
<blockquote>
<div><p>利用以上的流程，在<code class="docutils literal notranslate"><span class="pre">Hifive</span> <span class="pre">Unmatched</span></code>上运行多核通信的简易demo，用于说明SBI启动后主要进行的工作和相关硬件特性的利用。</p>
</div></blockquote>
<ul class="simple">
<li><p>首先进入sbi文件夹，插入SD卡后，修改Makefile中<code class="docutils literal notranslate"><span class="pre">image</span></code>任务的<code class="docutils literal notranslate"><span class="pre">of</span></code>内容为SD卡挂载的位置（可通过<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">fdisk</span> <span class="pre">-l</span></code>查看），执行<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">image</span></code>命令即可制作镜像并将镜像写入SD卡</p></li>
<li><p>演示用SBI入口地址为<code class="docutils literal notranslate"><span class="pre">0x80000000</span></code>，因为U-Boot SPL在初始化结束并加载第二分区后，会默认跳转到这一地址执行。</p></li>
<li><p>对于<code class="docutils literal notranslate"><span class="pre">uart</span></code>、<code class="docutils literal notranslate"><span class="pre">clint</span></code>等设备，读写采用原子操作，参考了OpenSBI相关实现</p></li>
<li><p>阻塞通信逻辑：</p>
<ul>
<li><p>小核和大核均清空clint软件中断，写入mie开启软件中断，然后大核进入循环等待消息；</p></li>
<li><p>小核向大核发出中断后，在预先协商好的地址<code class="docutils literal notranslate"><span class="pre">0x80100000</span></code>处写入通信内容，然后进入wfi等待唤醒；</p></li>
<li><p>大核接收到软件中断，从循环中跳出并输出一段信息报告当前硬件Hartid，并在串口打印小核之前在<code class="docutils literal notranslate"><span class="pre">0x80100000</span></code>写入的通信内容，最后向小核发送软件中断，进入wfi等待唤醒；</p></li>
<li><p>小核收到软件中断后重新执行以上步骤，由此便实现了多核之间的简易通信</p></li>
</ul>
</li>
<li><p>等待软件中断相关代码：</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">wait_ipi</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">hartid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// loop and wait for software interrupt</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">read_csr</span><span class="p">(</span><span class="n">mip</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MIP_MSIP</span><span class="p">))</span><span class="w"> </span>
<span class="w">        </span><span class="n">wfi</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// receive software interrupt now</span>
<span class="w">    </span><span class="n">clint_clear_soft</span><span class="p">(</span><span class="n">hartid</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>运行效果：</p></li>
</ul>
<p><img alt="" src="../_images/s7.png" /></p>
</div>
<div class="section" id="id6">
<h2>启动日志<a class="headerlink" href="#id6" title="永久链接至标题">#</a></h2>
<ul class="simple">
<li><p>（2021.11.18）OpenSBI首先进行一系列初始化，然后进行二级跳转到uboot，由于uboot运行在S态，无法在S7上加载程序，因此要重新配置OpenSBI</p>
<ul>
<li><p>论坛上的一个建议：可以通过向S7发送软件中断来唤醒，让S7跳转到事先准备好的中断处理程序中，最后返回到S7上运行的OS中</p></li>
<li><p>OpenSBI：系统调用；BootLoader</p></li>
<li><p>U-Boot最新版本有小问题，建议使用2019版本</p></li>
</ul>
</li>
<li><p>（2021.11.25）关于编译链的简介，可以看出需要从bitbake的配置文件入手，对编译依赖进行管理，可能会修改U-Boot SPL源码</p></li>
<li><p>（2021.11.27）阅读Freedom-U-SDK的生成的环境和配置文件，发现在<code class="docutils literal notranslate"><span class="pre">meta-sifive</span></code>中关于<code class="docutils literal notranslate"><span class="pre">unmatched</span></code>的相关配置</p></li>
<li><p>（2021.11.30）U54-MC多核启动流程：</p>
<ul>
<li><p>U54和U74架构基本一致</p></li>
<li><p>BootROM将SD卡指定分区中的代码加载到L2</p></li>
<li><p>L2可运行自己的多核代码，替代U-Boot SPL的功能</p></li>
<li><p>启发：U-Boot虽然好用，但是过重，不容易入手修改且调试困难，因此需要参考U-Boot SPL中的配置再重新编写启动代码</p></li>
</ul>
</li>
<li><p>（2021.12.02）考试结束，继续实验，试图分离U-Boot SPL失败，不过定位到了配置代码，此外在官网找到了<a class="reference external" href="https://github.com/sifive/freedom-u540-c000-bootloader">freedom-fu540-c000-bootloader</a>，也是从前天的讲座中获得了提示，开始往u540的板子相关工具链寻找参考，发现确实这方面已经非常完善了，于是开始拿来复用和修改，修改过程中加入了小核的启动，加入新的想法：</p>
<ul>
<li><p>增加交互控制，通过串口告知启动小核还是大核</p></li>
<li><p>由于有两个串口，可以分别启动进行展示（进行hartid的判断，对串口的MMIO地址进行选择</p></li>
<li><p>大小核通过MMIO的原子操作可以实现简单的通信</p></li>
</ul>
</li>
<li><p>（2021.12.03）进行了以下几个方面代码的编写和学习：</p>
<ul>
<li><p>GPT（GUID分区表）</p></li>
<li><p>SD</p></li>
<li><p>FDT（设备树</p></li>
</ul>
</li>
<li><p>（2021.12.04）FSBL运行失败，和luojia讨论后，决定先结合OpenSBI、FSBL、U-Boot实现可以多核通信的SBI</p></li>
<li><p>（2021.12.05）编写SBI代码，相关说明参见SBI-SMP</p></li>
<li><p>（2021.12.06）调试SBI，尝试在FU740上运行制作好的镜像</p></li>
<li><p>（2021.12.07）调整串口驱动，Debug</p></li>
<li><p>（2021.12.08）成功在小核上运行程序并看到串口输出</p></li>
<li><p>（2021.12.09）完成大小核简单通信demo，当前通信采用阻塞方式，具体参见SBI文档</p></li>
<li><p>（2021.12.10）尝试完善SBI的中断异常处理（未完成）</p></li>
</ul>
</div>
<div class="section" id="id7">
<h2>（附）相关工具<a class="headerlink" href="#id7" title="永久链接至标题">#</a></h2>
<div class="section" id="u-boot">
<h3>U-Boot 常用命令<a class="headerlink" href="#u-boot" title="永久链接至标题">#</a></h3>
<ul class="simple">
<li><p><strong>loadb</strong>：通过串口下载二进制文件</p></li>
<li><p><strong>printenv</strong>：打印环境变量，包括启动设备和起始地址等</p></li>
<li><p><strong>setenv</strong>：设置环境变量，例如boot之后运行的脚本选项：</p>
<ul>
<li><p><strong>baudrate</strong>：串口波特率，默认为115200</p></li>
<li><p><strong>boot_targets</strong>：列表包含nvme0，usb0，mmc0等，其中nvme0为SSD卡，我们拿到的主机上已装好了ubuntu系统；usb0为外接USB设备，mmc0即为SD卡，将该选项改为mmc0即可；</p></li>
<li><p>此外还包含一些网络相关的配置，可以从远程加载系统</p></li>
</ul>
</li>
<li><p><strong>fdt print /cpus；fdt list /cpus</strong>：查看设备信息，如图；可以看到cpu相关信息，大核和小核的架构不同，小核不支持页表，不支持浮点运算，且没有<strong>d-cache</strong></p></li>
</ul>
</div>
<div class="section" id="id8">
<h3>U-Boot 目录结构<a class="headerlink" href="#id8" title="永久链接至标题">#</a></h3>
<ul class="simple">
<li><p>/arch：与指令架构相关的代码，内容包括cpu相关代码，设备树相关代码，例如fu740的相关代码位于<code class="docutils literal notranslate"><span class="pre">/arch/riscv/cpu/fu740</span></code>下</p></li>
<li><p>/boot：</p></li>
<li><p>/board：与开发板相关的代码，例如unmatched的代码位于<code class="docutils literal notranslate"><span class="pre">/board/sifive/unmatched</span></code>下</p></li>
<li><p>/common：通用函数代码，包括环境加载、终端交互等</p></li>
<li><p>/include：头文件和开发板配置文件，所有开发板的配置文件在<code class="docutils literal notranslate"><span class="pre">/include/configs</span></code>目录下，例如unmatched相关配置在<code class="docutils literal notranslate"><span class="pre">/include/configs/sifive-unmatched.h</span></code>内</p></li>
<li><p>/drivers：设备驱动程序，主要有网络接口、串口等，例如sifive串口驱动位于<code class="docutils literal notranslate"><span class="pre">/drivers/serial/serial_sifive.c</span></code>内</p></li>
</ul>
</div>
<div class="section" id="spl">
<h3>SPL<a class="headerlink" href="#spl" title="永久链接至标题">#</a></h3>
<ul class="simple">
<li><p>SPL（Secondary Program Loader）是U-Boot第一阶段执行的代码，负责将U-Boot第二阶段执行的代码加载到内存中运行</p></li>
<li><p>SPL复用了U-Boot里面的代码，用来衔接SRAM和U-Boot</p></li>
<li><p>通过编译选项将SPL和U-Boot代码分离、复用，即<code class="docutils literal notranslate"><span class="pre">CONFIG_SPL_BUILD</span></code>，在<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">Kconfig</span></code>的时候使能，最终编译生成的二进制文件有<code class="docutils literal notranslate"><span class="pre">u-boot-spl</span></code>、<code class="docutils literal notranslate"><span class="pre">u-boot-spl.bin</span></code>以及<code class="docutils literal notranslate"><span class="pre">u-boot-spl.map</span></code></p></li>
</ul>
</div>
<div class="section" id="risc-v-gcc">
<h3>risc-v gcc<a class="headerlink" href="#risc-v-gcc" title="永久链接至标题">#</a></h3>
<ul class="simple">
<li><p>-march：指定目标平台所支持的模块化指令集合</p></li>
<li><p>-mabi：指定目标平台所支持的ABI函数调用规则</p>
<ul>
<li><p>前缀<code class="docutils literal notranslate"><span class="pre">ilp32</span></code>表示32位架构，int和long长度为32位，long long长度为64位</p></li>
<li><p>前缀<code class="docutils literal notranslate"><span class="pre">lp64</span></code>表示64位架构，int长度为32位，long长度为64位</p></li>
<li><p>后缀类型：</p>
<ul>
<li><p>无后缀：如果使用了浮点类型的操作，直接使用RISC-V浮点指令进行支持，但是当浮点数作为函数参数进行传递时，浮点数需要通过堆栈进行传递</p></li>
<li><p>f：表示目标平台支持硬件单精度浮点指令，且浮点数作为函数参数进行传递时，单精度浮点数可以通过寄存器传递，但双精度浮点数需要通过堆栈进行传递</p></li>
<li><p>d：表示目标平台支持硬件双精度浮点指令，且浮点数作为函数参数进行传递时，单精度和双精度都可以通过寄存器传递</p></li>
</ul>
</li>
</ul>
</li>
<li><p>-mcmodel：用于指定寻址范围的模式：</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">-mcmodel=medlow</span></code>：寻址范围固定在-2GB到2GB的空间内</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-mcmodel=medany</span></code>：寻址范围可以在任意4GB空间内</p></li>
</ul>
</li>
<li><p>由于S74核只支持IMAC指令集，因此本项目中采用<code class="docutils literal notranslate"><span class="pre">-march=rv64imac</span> <span class="pre">-mabi=lp64</span> <span class="pre">-mcmodel=medany</span></code>的组合</p></li>
</ul>
</div>
<div class="section" id="sifive-fusdk">
<h3>Sifive FUSDK<a class="headerlink" href="#sifive-fusdk" title="永久链接至标题">#</a></h3>
<ul class="simple">
<li><p>主要用途</p>
<ul>
<li><p>为Qemu、Unleashed、Unmatched构建预先定义的磁盘镜像</p></li>
<li><p>构建个性化第三方镜像</p></li>
<li><p>基于OpenEmbedded（提供交叉编译环境，为嵌入式系统构建完整的Linux</p></li>
<li><p>构建Bootloader（OpenSBI、U-Boot、U-Boot SPL</p></li>
<li><p>构建Device Tree（DTB</p></li>
<li><p>构建Linux镜像</p></li>
<li><p>磁盘分区</p></li>
</ul>
</li>
<li><p>以<code class="docutils literal notranslate"><span class="pre">demo-coreip-cli</span></code>镜像为例，在Unmatched上构建镜像，相关命令如下：</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkdir riscv-sifive <span class="o">&amp;&amp;</span> <span class="nb">cd</span> riscv-sifive
repo init -u git://github.com/sifive/freedom-u-sdk -b <span class="m">2021</span>.10 -m tools/manifests/sifive.xml
repo sync
<span class="c1"># optional</span>
repo start work --all
<span class="c1"># Setting up Building Environment</span>
bash ./freedom-u-sdk/setup.sh
<span class="c1"># BitBake</span>
<span class="nv">PARALLEL_MAKE</span><span class="o">=</span><span class="s2">&quot;-j 4&quot;</span> <span class="nv">BB_NUMBER_THREADS</span><span class="o">=</span><span class="m">4</span> <span class="nv">MACHINE</span><span class="o">=</span>unmatched bitbake demo-coreip-cli
</pre></div>
</div>
<ul class="simple">
<li><p>最后将镜像写入uSD Card：</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>xzcat demo-coreip-cli-unmatched.wic.xz <span class="p">|</span> sudo dd <span class="nv">of</span><span class="o">=</span>/dev/sdX <span class="nv">bs</span><span class="o">=</span>512K <span class="nv">iflag</span><span class="o">=</span>fullblock <span class="nv">oflag</span><span class="o">=</span>direct <span class="nv">conv</span><span class="o">=</span>fsync <span class="nv">status</span><span class="o">=</span>progress
</pre></div>
</div>
</div>
<div class="section" id="bitbake">
<h3>BitBake<a class="headerlink" href="#bitbake" title="永久链接至标题">#</a></h3>
<ul class="simple">
<li><p>BitBake是一个Python程序，由用户创建的配置驱动，为用户指定的目标执行用户创建的任务（recipes）；解决依赖关系；提供可配置的方式，将一些常见的任务例如下载源码包、解压、运行configure、运行make等进行抽象封装和重用</p></li>
<li><p>BitBake可以从<a class="reference external" href="https://github.com/openembedded/bitbake">这里</a>进行下载，按照文档的要求，将仓库下载到指定地址后，可以在<code class="docutils literal notranslate"><span class="pre">.bashrc</span></code>或<code class="docutils literal notranslate"><span class="pre">.zshrc</span></code>等配置文件中添加（建议先根据需求确定好版本，执行<code class="docutils literal notranslate"><span class="pre">bitbake</span> <span class="pre">--version</span></code>检查安装是否成功及当前版本</p></li>
</ul>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>/path/to/bbtutor/bitbake/bin:<span class="nv">$PATH</span>
<span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span>/path/to/bbtutor/bitbake/lib:<span class="nv">$PYTHONPATH</span>
</pre></div>
</div>
</div>
<div class="section" id="gpt">
<h3>GPT<a class="headerlink" href="#gpt" title="永久链接至标题">#</a></h3>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// GPT header</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">signature</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">revision</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">header_size</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">header_crc</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">reserved</span><span class="p">;</span><span class="w"> </span><span class="c1">// Reserved part must be 0x0</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">current_lba</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">backup_lba</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">first_usable_lba</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">last_usable_lba</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">gpt_guid</span><span class="w"> </span><span class="n">disk_guid</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">partition_entries_lba</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">num_partition_entries</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">partition_entry_size</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">partition_array_crc</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">padding</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">gpt_header</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>特点：</p>
<ul>
<li><p>64位LBA，可管理空间很大</p></li>
<li><p>128位GUID标识，不容易产生冲突</p></li>
<li><p>不限制分区数量</p></li>
<li><p>磁盘首尾各带一个表头，抗性较高</p></li>
<li><p>提供CRC校验</p></li>
</ul>
</li>
</ul>
</div>
</div>
</div>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="rust.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">学习 Rust</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="wifi.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">破解 WIFI</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, Kaifu Tian
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            目录
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">启动 S7 核</a><ul>
<li><a class="reference internal" href="#id1">硬件背景</a></li>
<li><a class="reference internal" href="#id2">启动准备</a></li>
<li><a class="reference internal" href="#id3">启动流程</a><ul>
<li><a class="reference internal" href="#sd">SD卡默认分区简介</a></li>
<li><a class="reference internal" href="#id4">制作镜像</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5">运行实例</a></li>
<li><a class="reference internal" href="#id6">启动日志</a></li>
<li><a class="reference internal" href="#id7">（附）相关工具</a><ul>
<li><a class="reference internal" href="#u-boot">U-Boot 常用命令</a></li>
<li><a class="reference internal" href="#id8">U-Boot 目录结构</a></li>
<li><a class="reference internal" href="#spl">SPL</a></li>
<li><a class="reference internal" href="#risc-v-gcc">risc-v gcc</a></li>
<li><a class="reference internal" href="#sifive-fusdk">Sifive FUSDK</a></li>
<li><a class="reference internal" href="#bitbake">BitBake</a></li>
<li><a class="reference internal" href="#gpt">GPT</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "tkf2019/Blog");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "comments");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script src="../_static/translations.js"></script>
    <script src="../_static/design-tabs.js"></script>
    </body>
</html>